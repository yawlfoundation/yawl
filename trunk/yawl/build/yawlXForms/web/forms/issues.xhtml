<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events">
    <head>
        <!--
        todos:
        - add status control - should only be accessible to user that the issue is assigned to
        - import username via context (remoteuser)
        -->
        <title>hello</title>
        <xf:model>
            <xf:submission id="debug" action="../jsp/debug-instance.jsp" method="post" replace="all"/>
            <xf:instance xmlns="">
                <data>
                    <issue id="0" reportedby="" created="">
                        <changes>
                            <change type=""
                                    assignedto=""
                                    status="new"
                                    version=""
                                    priority=""
                                    severity=""
                                    modified="">
                                <summary></summary>
                                <comment></comment>
                            </change>
                        </changes>
                    </issue>
                </data>
            </xf:instance>

            <!--<xf:bind id="b-issues" nodeset="issue[position() != last()]">-->
            <xf:bind id="b-issues" nodeset="issue">
                <xf:bind id="b-id" nodeset="@id" type="integer"/>
            </xf:bind>

            <xf:instance id="controller" xmlns="">
                <data>
                    <mode>new</mode>
                    <create/>
                </data>
            </xf:instance>
            <xf:bind id="b-mode" nodeset="instance('controller')/mode" relevant=".='edit'"/>

        </xf:model>
        <style type="text/css">
        #r-issue{width:100%;margin-top:20px;}
        .repeat-header{background:limegreen;}
        #summary-value{width:600px;}
        #comment-value{width:600px;height:300px;}
        #r-changes .output{display:block;}
        </style>
    </head>
    <body>

        <xf:switch id="menu">
            <xf:case id="allTickets" selected="true">
                <xf:trigger>
                    <xf:label>create Ticket</xf:label>
                    <xf:hint>create a new Ticket</xf:hint>
                    <xf:action>
                        <xf:toggle case="editTicket"/>
                        <xf:insert bind="b-issues" at="1" position="before"/>
                        <!-- set mode (create|edit|view) -->
                        <xf:setvalue ref="instance('controller')/mode" value="'create'"/>
                        <!-- set id -->
                        <xf:setvalue ref="issue/@id" value="format-number(max(/data/issue/@id)+1,'0')"/>
                        <!-- set created date -->
                        <xf:setvalue ref="issue/@created" value="now()"/>
                    </xf:action>
                </xf:trigger>
                <xf:trigger>
                    <xf:label>edit Ticket</xf:label>
                    <xf:hint>modify an existing Ticket</xf:hint>
                    <xf:toggle case="editTicket"/>
                    <!-- set mode (create|edit|view) -->
                    <xf:setvalue ref="instance('controller')/mode" value="'edit'"/>
                    <!-- insert a new change in the list of changes -->
                    <xf:insert nodeset="issue[index('r-issue')]/changes/change" at="1" position="before"/>
                    <xf:rebuild/>
                    <!-- copy all values from previous change for editing. Would be much easier with XForms 1.1 -->
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/@type" value="/data/issue[index('r-issue')]/changes/change[2]/@type"/>
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/@assignedto" value="/data/issue[index('r-issue')]/changes/change[2]/@assignedto"/>
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/@status" value="/data/issue[index('r-issue')]/changes/change[2]/@status"/>
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/@version" value="/data/issue[index('r-issue')]/changes/change[2]/@version"/>
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/@priority" value="/data/issue[index('r-issue')]/changes/change[2]/@priority"/>
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/@severity" value="/data/issue[index('r-issue')]/changes/change[2]/@severity"/>
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/summary" value="/data/issue[index('r-issue')]/changes/change[2]/summary"/>
                    <xf:setvalue ref="/data/issue[index('r-issue')]/changes/change[1]/comment" value="/data/issue[index('r-issue')]/changes/change[2]/comment"/>

                </xf:trigger>

                <xf:repeat bind="b-issues" id="r-issue" appearance="compact">
                    <xf:output ref="@id">
                        <xf:label>Ticket</xf:label>
                    </xf:output>
                    <xf:output ref="changes/change/summary">
                        <xf:label>Summary</xf:label>
                    </xf:output>
                    <xf:output ref="changes/change/@type">
                        <xf:label>Type</xf:label>
                    </xf:output>
                    <xf:output ref="changes/change/@status">
                        <xf:label>Status</xf:label>
                    </xf:output>
                    <xf:output ref="changes/change/@severity">
                        <xf:label>Severity</xf:label>
                    </xf:output>
                    <xf:output ref="changes/change/@priority">
                        <xf:label>Priority</xf:label>
                    </xf:output>
                    <xf:output ref="changes/change/@assignedto">
                        <xf:label>Owner</xf:label>
                    </xf:output>
                    <xf:output ref="@created">
                        <xf:label>created</xf:label>
                    </xf:output>

                </xf:repeat>
            </xf:case>
            <xf:case id="editTicket" selected="false">
                <xf:group ref="issue/changes/change[1]" appearance="full">
                    <xf:label>Ticket</xf:label>
                    <xf:input id="summary" ref="summary">
                        <xf:label>Short Summary</xf:label>
                    </xf:input>
                    <xf:textarea id="comment" ref="comment">
                        <xf:label>Description</xf:label>
                    </xf:textarea>
<!--
                    <xf:group appearance="full">
                        <xf:label>Properties</xf:label>
-->
                        <xf:select1 ref="@type">
                            <xf:label>Type</xf:label>
                            <xf:choices>
                                <xf:item>
                                    <xf:label>Feature</xf:label>
                                    <xf:value>Feature</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Defect</xf:label>
                                    <xf:value>Defect</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>Change Request</xf:label>
                                    <xf:value>Change</xf:value>
                                </xf:item>
                            </xf:choices>
                        </xf:select1>
                        <xf:input ref="@assignedto">
                            <xf:label>assign to:</xf:label>
                        </xf:input>
                        <xf:select1 ref="@status">
                            <xf:label>Status</xf:label>
                            <xf:item>
                                <xf:label>new</xf:label>
                                <xf:value>new</xf:value>
                            </xf:item>
                            <xf:item>
                                <xf:label>accepted</xf:label>
                                <xf:value>accepted</xf:value>
                            </xf:item>
                            <xf:item>
                                <xf:label>assigned</xf:label>
                                <xf:value>assigned</xf:value>
                            </xf:item>
                            <xf:item>
                                <xf:label>closed</xf:label>
                                <xf:value>closed</xf:value>
                            </xf:item>
                        </xf:select1>
                        <xf:select1 ref="@priority" appearance="minimal">
                            <xf:label>Priority</xf:label>
                            <xf:choices>
                                <xf:item>
                                    <xf:label>highest</xf:label>
                                    <xf:value>highest</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>high</xf:label>
                                    <xf:value>high</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>normal</xf:label>
                                    <xf:value>normal</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>low</xf:label>
                                    <xf:value>low</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>lowest</xf:label>
                                    <xf:value>lowest</xf:value>
                                </xf:item>
                            </xf:choices>
                        </xf:select1>
                        <xf:select1 ref="@severity" appearance="minimal">
                            <xf:label>Severity</xf:label>
                            <xf:choices>
                                <xf:item>
                                    <xf:label>stopper</xf:label>
                                    <xf:value>stopper</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>critical</xf:label>
                                    <xf:value>critical</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>major</xf:label>
                                    <xf:value>major</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>normal</xf:label>
                                    <xf:value>normal</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>minor</xf:label>
                                    <xf:value>minor</xf:value>
                                </xf:item>
                                <xf:item>
                                    <xf:label>trivial</xf:label>
                                    <xf:value>trivial</xf:value>
                                </xf:item>
                            </xf:choices>
                        </xf:select1>
                        <xf:input ref="@version">
                            <xf:label>Version</xf:label>
                        </xf:input>
                    <!--</xf:group>-->
                    <xf:group bind="b-mode">
                        <xf:label>History</xf:label>

                        <xf:repeat id="r-changes" nodeset="/data/issue[index('r-issue')]/changes/change[position() &gt; 1]" appearance="full">
                            <xf:output ref="summary">
                                <xf:label>Short Summary</xf:label>
                            </xf:output>
                            <xf:output ref="comment">
                                <xf:label>Description</xf:label>
                            </xf:output>
                            <xf:output ref="@type">
                                <xf:label>Type</xf:label>
                            </xf:output>
                            <xf:output ref="@assignedto">
                                <xf:label>assigned to</xf:label>
                            </xf:output>
                            <xf:output ref="@status">
                                <xf:label>Status</xf:label>
                            </xf:output>
                            <xf:output ref="@priority">
                                <xf:label>Priority</xf:label>
                            </xf:output>
                            <xf:output ref="@severity">
                                <xf:label>Severity</xf:label>
                            </xf:output>
                            <xf:output ref="@version">
                                <xf:label>Version</xf:label>
                            </xf:output>
                            <xf:output ref="@modified">
                                <xf:label>modified</xf:label>
                            </xf:output>
                        </xf:repeat>
                    </xf:group>
                    <xf:trigger>
                        <xf:label>Ok</xf:label>
                        <xf:action>
                            <!-- crazy hack to make setting of index work -->
                            <xf:setindex repeat="r-issue" index="last()"/>
                            <xf:toggle case="allTickets"/>
                            <xf:setindex repeat="r-issue" index="1"/>
                        </xf:action>
                    </xf:trigger>
                </xf:group>
            </xf:case>
        </xf:switch>
    </body>
</html>
