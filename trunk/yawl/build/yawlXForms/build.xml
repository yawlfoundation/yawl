<?xml version="1.0" encoding="iso-8859-1" ?>

<!-- ================================================== -->
<!-- BUILDFILE FOR YAWLXFORMS - based on CHIBA, a web-based xforms processor

     call ant with the target as, e.g.

        ant -find build.xml compile


     the main targets are:

     compile-all
        compiles all core and extension classes

     deploy
        creates the correct deployment directory structure in build.dir and
        copies all web (html, jsp, images) and configuration (web.xml)
        related data there.

     javadoc
        creates the javadocumentation for the java classes into doc.dir/api

     distribute
        creates two distribution files app.name-app.version-src.jar and
        app.name-app.version.jar, a source distribution (identical to the
        source directory) and a binary distribution (identical to the
        deploy.dir directory).  the two files are created in dist.dir

     junit
        runs the included junit tests.


     And if everything has become dirty and filthy and crap use:

     clean
        this target removes all compiled java classes from the build.dir,
        but does not touch the rest (jsp, html, xml, stylesheets)

     clean-all
        this target removes all - and this means really all!  If you've
        changed files, like jsp, stylesheets etc. they are simply removed!
        so using this target means you know what you are doing

     kill-all
        as clean-all but also deletes your webapps directory in the home
        of your webcontainer

    schema2XForms
        this target generates an XForm from an W3C XMLSchema document.
        A number of parameters need to be specified in order for it to work
        (parameters are passed with -DparameterName=parameterValue):

        - schema2XForms.xform: name of the xform to generate: there must be a
        directory with this name under the "xforms" directory, and the schema
        in this directory must be called with this name followed by .xsd

        - schema2XForms.rootTagName: the "root" element name of the XML instance
        corresponding to this schema
        schema2XForms.instanceFile and schema2XForms.instanceHref: the instance
        XML document can be specified either as a file, in which case it will be
        included in the generated XForms, or as a URI, in which case a "href" link
        will be set on the "instance" element of the generated XForms

        - schema2XForms.action: this parameter will be set in the "action"
        attribute of the "submission" element in the generated XForms document

        - schema2XForms.submitMethod: this parameter will be set in the "method"
        attribute of the "submission" element in the generated XForms document

        - schema2XForms.wrapperType: specify the kind of wrapper elements that will
        be generated in the XForms document.
        Default will generate default, platform independant elements, while
        "HTML" wrapperType will generate an XHTML document

        - schema2XForms.stylesheet: name of the transformation stylesheet to use.
        If none is specified, the default HTML stylesheet is used.
	
	- schema2XForms.useSchemaTypes: use types given in the XMLSchema whenever possible
	for simple types (the XMLSchema will need to be accessible from the XForms)
  -->

<project name="YAWLXForms" default="distribute" basedir=".">


    <!-- the setting for TOMCAT_HOME in your environment will be used to locate your tomcat
         installation. If you like to use a different one, set the value of the property 'webapps.dir'
         to the absolute path on your disk. -->
    <property environment="env"/>
    <property name="webapps.dir" value="${env.CATALINA_HOME}/webapps"/>

	<property name="app.name" value="yawlXForms"/>
	
    <!--Host address and port for sample files base url-->
    <property name="tokens.file" value="./tokens.properties"/>

    <!-- directory variables -->
    <property name="deploy.dir" value="${webapps.dir}/${app.name}"/>
    <property name="src.dir" value="src"/>
    <property name="lib.dir" value="../3rdParty/xforms-lib"/>
    <property name="extension.lib.dir" value="../3rdParty/xforms-lib/extension"/>
    <property name="doc.dir" value="doc"/>
    <property name="etc.dir" value="etc"/>
    <property name="web.dir" value="web"/>
    <property name="build.dir" value="build"/>
    <property name="dist.dir" value="dist"/>
	<property name="graphics.dir" value="graphics"/>
	<property name="yawl.lib.dir" value="../3rdParty/lib"/>
	
    <!-- the following properties are questionable - should be removed if not needed -->
    <property name="documents.dir" value="documents"/>
    <property name="forms.dir" value="forms"/>
	
    <property name="excludes" value="excludes.properties"/>
	
	
    <!-- ==================================================-->
    <!-- properties used by the schema2XForms generator
        (target=schema2Xforms) -->
    <!-- ================================================== -->
    <!-- schema2XForms.xform: name of the xform to generate: there must be a directory with this name
    under the "xforms" directory, and the schema in this directory must be called
    with this name followed by .xsd -->
    <property name="schema2XForms.xform" value="buglet"/>
    <!-- schema2XForms.rootTagName: the "root" element name of the XML instance
    corresponding to this schema -->
    <property name="schema2XForms.rootTagName" value="basicSchemaTest"/>
    <!-- schema2XForms.instanceFile and schema2XForms.instanceHref: the instance
    XML document can be specified either as a file, in which case it will be
    included in the generated XForms, or as a URI, in which case a "href" link
    will be set on the "instance" element of the generated XForms-->
    <property name="schema2XForms.instanceFile" value=""/>
    <property name="schema2XForms.instanceHref" value=""/>
    <!-- schema2XForms.action: this parameter will be set in the "action" attribute
    of the "submission" element in the generated XForms document -->
    <property name="schema2XForms.action" value=""/>
    <!-- schema2XForms.submitMethod: this parameter will be set in the "method"
    attribute of the "submission" element in the generated XForms document -->
    <property name="schema2XForms.submitMethod" value=""/>
    <!-- schema2XForms.wrapperType: specify the kind of wrapper elements that will
    be generated in the XForms document.
    Default will generate an XHTML document that works with Chiba -->
    <property name="schema2XForms.wrapperType" value="HTML"/>
    <!--schema2XForms.stylesheet: name of the transformation stylesheet to use.
    If none is specified, the default HTML stylesheet is used.-->
    <property name="schema2XForms.stylesheet" value=""/>
    <!--schema2XForms.base: the xml:base attribute of the generated XForms,
    for example http://localhost:8080/chiba-0.9.3/
    it is only needed if the "action" or the "instanceHref" parameters are relative
    -->
    <property name="schema2XForms.base" value=""/>
    <!-- schema2XForms.useSchemaTypes: use types given in the XMLSchema whenever possible
	for simple types (the XMLSchema will need to be accessible from the XForms)-->
    <property name="schema2XForms.useSchemaTypes" value="true"/>
	
    <property name="schema2XForms.generated.dir" value="generated"/>
    <property name="schema2XForms.xforms.dir" value="xforms"/>
	
    <!-- ================================================== -->
    <!--     classpathes                                    -->
    <!-- ================================================== -->
    <path id="compile.class.path" description="classpath for compiling core classes">
        <fileset dir="${lib.dir}" includes="*.jar"/>
        <pathelement path="${build.dir}/WEB-INF/classes"/>
    </path>

    <path id="compile.all.class.path" description="classpath for compiling core plus all extension classes">
        <fileset dir="${lib.dir}" includes="**/*.jar"/>
        <pathelement path="${build.dir}/WEB-INF/classes"/>
		<pathelement path="${yawl.lib.dir}/junit.jar"/>
    	<pathelement path="${yawl.lib.dir}/commons-logging.jar"/>
        <pathelement path="${yawl.lib.dir}/log4j-1.2.8.jar"/>
    </path>

    <!-- todo: really needed ?   -->
    <path id="jar.compile.class.path">
        <pathelement path="${build.dir}/WEB-INF/classes"/>
        <pathelement path="${lib.dir}/bsf.jar"/>
        <pathelement path="${lib.dir}/commons-codec-1.2.jar"/>
        <pathelement path="${lib.dir}/commons-fileupload-1.0.jar"/>
        <pathelement path="${lib.dir}/commons-httpclient-2.0.1.jar"/>
        <pathelement path="${lib.dir}/commons-jxpath-1.2.jar"/>
        <pathelement path="${yawl.lib.dir}/commons-logging.jar"/>
        <pathelement path="${lib.dir}/dom3-xercesImpl.jar"/>
        <pathelement path="${lib.dir}/dom3-xml-apis.jar"/>
        <pathelement path="${yawl.lib.dir}/log4j-1.2.8.jar"/>
        <pathelement path="${lib.dir}/mail.jar"/>
        <pathelement path="${lib.dir}/activation.jar"/>
        <pathelement path="${lib.dir}/servlet.jar"/>
    </path>


    <path id="run.class.path">
        <fileset dir="${lib.dir}" includes="**/*.jar"/>
        <pathelement path="${build.dir}/WEB-INF/classes"/>
    </path>

    <!-- ====================================================================== -->
    <!--    setup                                                               -->
    <!-- ====================================================================== -->
    <target name="prepare" depends="publish">
        <echo message=""/>
        <echo message="---------- preparing: creating dirs and copying files ----------"/>
        <echo message=""/>

        <tstamp/>
        <filter filtersfile="${tokens.file}"/>

        <condition property="VM">
            <contains string="${java.version}" substring="1.4"/>
        </condition>

        <echo message="JDK1.4: ${VM}"/>
        <echo message="current JDK: ${java.version}"/>

    	<delete dir="${build.dir}"/>
    	
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${build.dir}/WEB-INF"/>
        <mkdir dir="${build.dir}/WEB-INF/classes"/>
        <mkdir dir="${build.dir}/WEB-INF/xslt"/>
        <mkdir dir="${build.dir}/upload"/>
    	<mkdir dir="${build.dir}/graphics"/>

        <!--
        copy all xml files in the correct dirs. These include
        configuration- and test-files which are located in the
        java src-package structure.
        -->
        <delete file="${build.dir}/WEB-INF/classes/org/chiba/xml/xforms/version.info"/>
    	
        <copy description="copy resources to package tree" todir="${build.dir}/WEB-INF/classes" filtering="true" includeemptydirs="false">
            <fileset dir="${src.dir}" excludes="org/**/*.java tools/**/*.* au/**/*.java"/>
        </copy>

        <replace description="update build number" file="${build.dir}/WEB-INF/classes/org/chiba/xml/xforms/version.info">
            <replacefilter token="@version.build@" value="${DSTAMP}/${TSTAMP}"/>
        </replace>

        <!-- copies images 
        <copy todir="${build.dir}/WEB-INF/classes" filtering="false">
            <fileset dir="${src.dir}" includes="**/*.png"/>
        </copy>
         -->
    	
        <copy description="copy web.xml" file="${etc.dir}/web.xml" todir="${build.dir}/WEB-INF"/>
        <copy description="copy log4j config" file="${etc.dir}/log4j.xml" todir="${build.dir}/WEB-INF"/>
        <copy description="copy log4j dtd" file="${etc.dir}/log4j.dtd" todir="${build.dir}/WEB-INF"/>

        <copy description="copy web pages" todir="${build.dir}" filtering="true">
            <fileset dir="${web.dir}">
                <include name="*.html"/>
            </fileset>
        </copy>

        <copy description="copy image files" todir="${build.dir}/images" filtering="false">
            <fileset dir="${web.dir}/images"/>
        </copy>

        <copy description="copy jsp pages" todir="${build.dir}/jsp">
            <fileset dir="${web.dir}/jsp"/>
        </copy>

        <copy description="copy CSS stylesheets" todir="${build.dir}/styles">
            <fileset dir="${web.dir}/styles"/>
        </copy>

        <copy description="copy javascript files" todir="${build.dir}/scripts">
            <fileset dir="${web.dir}/scripts"/>
        </copy>

        <copy description="copy sample forms" todir="${build.dir}/${forms.dir}" filtering="true">
            <fileset dir="${web.dir}/${forms.dir}"
                includes="**/*.xhtml **/*.xml"/>
        </copy>

        <copy description="copy XSLT styleheets" todir="${build.dir}/WEB-INF/xslt" filtering="true">
            <fileset dir="${src.dir}/org/chiba/tools/xslt" includes="*.xsl"/>
        </copy>
    	
        <copy description="copy YAWL graphics files" todir="${build.dir}/graphics">
            <fileset dir="${web.dir}/graphics" includes="*.gif *.jpg yawl.swf common.css"/>
        </copy>    	
    </target>

    <!-- ====================================================================== -->
    <!--    building                                                            -->
    <!-- ====================================================================== -->
    <target name="compile-all" depends="prepare" description="compiling all core and extension classes">
        <echo message=""/>
        <echo message="---------- compiling all core and extension classes ----------"/>
        <echo message=""/>

        <filter filtersfile="${tokens.file}"/>

        <javac description="compiling core classes"
            srcdir="${src.dir}"
            destdir="${build.dir}/WEB-INF/classes"
            classpathref="compile.all.class.path"
            debug="on"
            optimize="off"
            deprecation="off"
            />
    </target>

    <!-- ====================================================================== -->
    <!-- deployment                                                             -->
    <!-- ====================================================================== -->
    <target name="deploy-prepare" depends="compile-all">
        <!-- create needed directories -->
        <echo message=""/>
        <echo message="---------- preparing webapp directory structure ----------"/>
        <echo message=""/>
        <mkdir dir="${deploy.dir}"/>
        <mkdir dir="${deploy.dir}/WEB-INF/lib"/>
        <mkdir dir="${deploy.dir}/WEB-INF"/>
        <mkdir dir="${deploy.dir}/WEB-INF/classes"/>
        <mkdir dir="${deploy.dir}/WEB-INF/xslt"/>
        <mkdir dir="${deploy.dir}/${forms.dir}"/>
        <mkdir dir="${deploy.dir}/documents"/>
        <mkdir dir="${deploy.dir}/api"/>
        <mkdir dir="${deploy.dir}/images"/>
        <mkdir dir="${deploy.dir}/tmp"/>
        <mkdir dir="${deploy.dir}/upload"/>
    	<mkdir dir="${deploy.dir}/graphics"/>
    </target>

    <target name="deploy" depends="deploy-prepare, publish" description="deploy Chiba into your webcontainer">
        <filter filtersfile="${tokens.file}"/>

        <copy file="${etc.dir}/web.xml" todir="${deploy.dir}/WEB-INF" description="webapp configuration file"/>
        <copy file="${etc.dir}/log4j.xml" todir="${deploy.dir}/WEB-INF" description="log4j configuration file"/>

        <copy todir="${deploy.dir}/WEB-INF/xslt" filtering="true" description="XSLT stylesheets">
            <fileset dir="${build.dir}/WEB-INF/xslt"/>
        </copy>

        <copy todir="${deploy.dir}" description="html pages">
            <fileset dir="${build.dir}">
                <include name="*.html"/>
            </fileset>
        </copy>

        <copy todir="${deploy.dir}/jsp" description="jsp files">
            <fileset dir="${build.dir}/jsp"/>
        </copy>

        <copy todir="${deploy.dir}/styles" description="CSS files">
            <fileset dir="${build.dir}/styles"/>
        </copy>

        <copy todir="${deploy.dir}/scripts" description="javascript files">
            <fileset dir="${build.dir}/scripts"/>
        </copy>

        <copy todir="${deploy.dir}/${forms.dir}" filtering="true" description="sample forms">
            <fileset dir="${build.dir}/${forms.dir}"
                includes="**/*.xhtml **/*.xml"/>
        </copy>

        <copy todir="${deploy.dir}/${forms.dir}/conformance" description="conformance test files">
            <fileset dir="${src.dir}/org/chiba/test/conformance"
                excludes="**/*.java"/>
        </copy>

        <copy todir="${deploy.dir}/images" filtering="false" description="image files">
            <fileset dir="${build.dir}/images"/>
        </copy>

       <copy todir="${deploy.dir}/graphics" filtering="false" description="YAWL image files">
           <fileset dir="${build.dir}/graphics"/>
       </copy>
    	
        <copy todir="${deploy.dir}/WEB-INF/lib" description="lib files">
            <fileset dir="${lib.dir}">
                <include name="activation.jar"/>
                <include name="commons-codec-1.2.jar"/>
                <include name="commons-fileupload-1.0.jar"/>
                <include name="commons-httpclient-2.0.1.jar"/>
                <include name="commons-jxpath-1.2.jar"/>
                <include name="dom3-xercesImpl.jar"/>
                <include name="dom3-xml-apis.jar"/>
                <include name="mail.jar"/>
            	<include name="xalan.jar"/>
            	<include name="yawl-WIR-toolkit.jar"/>
            </fileset>
        	
        	<fileset dir="${yawl.lib.dir}">
        		<include name="log4j-1.2.8.jar"/>
        		<include name="commons-logging.jar"/>
        	</fileset>
        	
        </copy>

        <copy todir="${deploy.dir}/WEB-INF/classes" description="java class files and runtime resources" includeemptydirs="false">
            <fileset dir="${build.dir}/WEB-INF/classes"
                excludes="**/test/**/*.* **/Makefile"/>
        </copy>
    	
    </target>

    <!-- ================================================== -->
    <!--    distribution                                    -->
    <!-- ================================================== -->
    <!-- creates three distribution files.
    [1] chiba-x.y-src.tar.gz - Unix style source-file
    [2] chiba-x.y-src.zip - Windows style source-file
        both contain the complete source tree
    [3] chiba-x.y.war
        which contains a complete stand alone chiba webarchive (including
        forms, integrating jsps, images, additional stylesheets for
        application integration etc.)  This second jar is NOT the jar to use
        for integration in your application!  Use the target 'build-chiba-jar' for
        that purpose!
    -->
    <target name="distribute" depends="compile-all,publish">
        
    	<delete dir="$dist.dir"/>
    	
    	<mkdir dir="${dist.dir}"/>

        <!-- build war dist -->
        <delete file="${build.dir}/WEB-INF/web.xml"/>
        <war warfile="${dist.dir}/${app.name}.war"
            webxml="${etc.dir}/web.xml"
            basedir="${build.dir}"
            excludes="**/test/**">
            <lib dir="${lib.dir}">
                <include name="activation.jar"/>
                <include name="commons-codec-1.2.jar"/>
                <include name="commons-fileupload-1.0.jar"/>
                <include name="commons-httpclient-2.0.1.jar"/>
                <include name="commons-jxpath-1.2.jar"/>
                <include name="dom3-xercesImpl.jar"/>
                <include name="dom3-xml-apis.jar"/>
                <include name="mail.jar"/>
            	<include name="xalan.jar"/>
            	<include name="yawl-WIR-toolkit.jar"/>
            </lib>
        	
        	<lib dir="${yawl.lib.dir}">
        		<include name="log4j-1.2.8.jar"/>
        		<include name="commons-logging.jar"/>
        	</lib>
        </war>
        <delete dir="${build.dir}"/>

    </target>


    <!-- ================================================== -->
    <!--    cleanup                                         -->
    <!-- ================================================== -->
    <target name="clean" description="clean all classes">
        <delete dir="${build.dir}/WEB-INF/classes">
            <fileset dir="."
                includes="*.class"/>
        </delete>
    </target>

    <target name="clean-all" description="clean the complete build-dir">
        <delete dir="${build.dir}"/>
        <delete dir="${doc.dir}/api"/>
        <delete dir="${doc.dir}/test"/>
        <delete dir="${test.dir}"/>
    </target>

    <target name="kill-all" depends="clean-all">
        <delete dir="${deploy.dir}"/>
    </target>

    <!-- ================================================== -->
    <!--    targets for building Chiba web pages from xml   -->
    <!-- ================================================== -->
    <target name="init">
        <tstamp>
            <format property="now" pattern="dd/MM/yyyy hh:mm aa"
                unit="hour"/>

        </tstamp>
        <echo message="current date: ${now}"/>
    </target>

    <target name="publish" depends="init">

        <delete dir="${web.dir}/online-pages"/>
        <style basedir="${web.dir}/xml"
            destdir="${web.dir}"
            extension=".html"
            style="${web.dir}/xml/xsl/simplelayout.xsl"
            includes="*.xml">
            <param name="upDate" expression="${now}"/>
        </style>
    </target>
	
</project>
