<project name="YAWLEditor" default="buildJars" basedir="./..">

    <!--
	YAWL Editor Ant build script. Requires Ant v1.7+

	As a convention, only those targets normally run directly are given a
	description attribute. Targets are split into categories and listed in
	a rough 'top-down' order for ease of understanding
    -->


	<!-- =========INITIAL PROPERTIES, FILTERS, FILESETS & CHECKS=========== -->

    <!--
    	Load properties from file
    -->
	<property name="build.dir" value="build" />
    <property file="${build.dir}/build.properties" />

    <!--
    	Current editor and engine version numbers (from properties file)
    -->
    <filter token="EditorReleaseNumber" value="${editor.release.number}" />
    <filter token="CompatibleEngineReleaseNumber" value="${compatible.engine.release.number}" />

    <!--
    	Define root class name, path and directories
    -->
    <property name="root.class.name" value="YAWLEditor" />
    <property name="root.source.file" value="${root.class.name}.java" />
    <property name="package.base.dir" value="org/yawlfoundation/yawl" />
    <property name="package.dir" value="${package.base.dir}/editor" />
    <property name="root.classpath"
              value="org.yawlfoundation.yawl.editor.ui.${root.class.name}" />
    <property name="source.file" value="${package.dir}/ui/${root.source.file}" />
    <property name="source.release" value="1.6" />

    <!--
    	Define input & output directories
    -->
	<property name="tempBuild.dir" value="temp" />
    <property name="source.dir" value="source" />
    <property name="classes.dir" value="classes" />
    <property name="distribution.dir" value="output" />
    <property name="library.dir" value="lib" />
    <property name="tools.dir" value="tools" />
    <property name="javadoc.dir" value="${distribution.dir}/javadoc" />

    <!--
    	Define output file names
    -->
    <property name="source.zip"
              value="${root.class.name}${editor.release.number}Source.zip" />
    <property name="ui.jar.name"
              value="${root.class.name}${editor.release.number}.jar" />
    <property name="core.jar.name"
              value="${root.class.name}-core-${editor.release.number}.jar" />
    <property name="analyser.jar.name"
              value="${root.class.name}-analyser-${editor.release.number}.jar" />
    <property name="icons.jar.name"
              value="${root.class.name}-icons.jar" />
    <property name="jgraph.jar.name"
              value="jgraph4yawl-${editor.release.number}.jar" />

	<!--
		Define all Editor code dependencies. Since the Editor makes use of
		YAWL services code, there are runtime dependencies to libraries
		YAWL services code uses (and some of these libraries, such as log4j, are
		also used by Editor code and *not* stored in the Editor source tree to
		avoid compatibility and maintenance issues).

		Compiled YAWL services code and its dependencies are referenced by
		the properties file compatible.engine.* entries. We therefore define
        here:
			Editor-only dependencies (stored in the Editor source tree);
			any YAWL Services dependencies we know we *don't* need;
			the full set of required packages for the Complete build
	-->
    <property name="automaton" value="automaton.jar"/>
    <property name="bounce" value="bounce-0.18.jar"/>
    <property name="forms" value="forms_rt.jar"/>
    <property name="imgscalr" value="imgscalr-lib-4.2.jar"/>
    <property name="jcal" value="jcalendar-1.4.jar"/>
    <property name="goodies-common" value="jgoodies-common-1.6.0.jar"/>
    <property name="goodies-looks" value="jgoodies-looks-2.5.3.jar"/>
    <property name="l2fprod" value="l2fprod-common-all.jar"/>
    <property name="servlet" value="servlet-api.jar"/>
	<property name="junit" value="junit-4.4.jar"/>

	<fileset id="editorOnlyDeps" dir="${library.dir}"
			 includes="${jcal} ${servlet} ${forms} ${bounce} ${imgscalr}
			           ${goodies-common} ${goodies-looks} ${l2fprod} ${automaton}" />

	<fileset id="junitDeps" file="${tools.dir}/${junit}" />

    <!--
       This list must be carefully maintained to avoid jar bloat
    -->   
	<property name="unneededEngineLibs"
			  value="activation.jar apache_soap*.jar appbase.jar axis*.jar bc*.jar
			         c3*.jar collection*.jar colt*.jar commons-beanutils.jar
			         commons-di*.jar commons-file*.jar commons-io*.jar concurrent*.jar
			         dataprovider.jar defaulttheme*.jar derby*.jar ehcache*.jar
			         errorhandler.jar h2*.jar hsql*.jar jaxrpc.jar jboss*.jar jsf*.jar
			         json.jar jstl.jar jung*.jar junit*.jar mail*.jar mysql*.jar
			         ojdbc*.jar postgres*.jar rowset.jar saaj.jar servlet*.jar
		 			 simple*.jar slf4j*.jar smtp.jar soaprmi*.jar sonar*.jar sqlx.jar
		 			 standard.jar stax*.jar twitter*.jar ucp.jar webui.jar wsdl*.jar
		 			 wsif*.jar xml*.jar" />

	<fileset id="neededEngineDeps"
			 dir="../${compatible.engine.depsLib}"
	    	 includes="*.jar"
	    	 excludes="${unneededEngineLibs}" />


	<!--
		Check YAWL Services dependencies are where we expect they are
	-->
	<fail message="Parent-relative Engine path ${compatible.engine.libJAR.path} not found">
		<condition>
			<available file="${compatible.engine.libJAR.path}" type="file" />
		</condition>
	</fail>
    
	<fail message="Parent-relative Engine path ${compatible.engine.depsLib} not found">
		<condition>
			<available file="${compatible.engine.depsLib}" type="dir" />
		</condition>
	</fail>


	<!-- ==================MAIN EDITOR BUILD TARGETS======================= -->

	<!--
		Build Lite Editor with all dependencies in external JARs, which must
	    remain in a lib folder relative to the Editor JARs location (as set up
	    in the output directory). All dependencies are added explicitly to the
	    manifest's Class-Path, so the Editor can be run simply as java -jar ...
	-->
    <target name="buildUIJar"
            depends="compile"
  	        description="Build the Editor UI jar (the main jar)">

        <property name="manifestFile" value="${root.class.name}.mf" />

    	<manifestclasspath property="manifest_cp"
    					   jarfile="${distribution.dir}/${ui.jar.name}">
    		<classpath>
    			<fileset dir="${distribution.dir}/lib" includes="*.jar" />
    		</classpath>
    	</manifestclasspath>

        <manifest file="${manifestFile}">
            <attribute name="Main-Class" value="${root.classpath}" />
        	<attribute name="Class-Path" value="${manifest_cp}" />
            <attribute name="SplashScreen-Image"
                       value="${package.dir}/ui/resources/yawlSplashScreen.jpg" />
        </manifest>

        <propertyfile file="${build.dir}/version.properties">
            <entry key="Version" value="${editor.release.number}"/>
            <entry key="BuiltBy" value="${user.name}"/>
            <entry key="BuildDate" type="date" value="now"/>
            <entry key="BuildNumber" default="0" type="int" operation="+" value="1"/>
            <entry key="JavaVersion" value="${java.version}"/>
            <entry key="OS" value="${os.name}"/>
            <entry key="OSVersion" value="${os.version}"/>
        </propertyfile>
        <copy file="${build.dir}/version.properties"
              tofile="${classes.dir}/version.properties"/>

        <jar jarfile="${distribution.dir}/${ui.jar.name}"
             basedir="${classes.dir}"
             manifest="${manifestFile}"
             includes="${package.dir}/ui/** version.properties"
             excludes="**/Test*.class ${package.dir}/ui/resources/taskicons/**" />
        <checksum file="${distribution.dir}/${ui.jar.name}"/>
        <delete file="${manifestFile}" />
    </target>


    <target name="buildAnalyserJar"
            depends="compile,copyLibs"
  	        description="Build the Analyser library">

        <jar jarfile="${distribution.dir}/lib/${analyser.jar.name}"
             basedir="${classes.dir}"
             includes="${package.base.dir}/analyser/**"
             excludes="**/Test*.class" />
        <checksum file="${distribution.dir}/lib/${analyser.jar.name}"
                  toDir="${distribution.dir}"/>
    </target>

    <target name="buildResourcesJar"
            depends="copyLibs"
  	        description="Build the Resources library">

        <jar jarfile="${distribution.dir}/lib/${icons.jar.name}"
             basedir="${classes.dir}"
             includes="${package.dir}/ui/resources/taskicons/**"/>
        <checksum file="${distribution.dir}/lib/${icons.jar.name}"
                  toDir="${distribution.dir}"/>
    </target>


    <target name="buildCoreJar"
            depends="compile,copyLibs"
  	        description="Build the Editor Core library">

        <jar jarfile="${distribution.dir}/lib/${core.jar.name}"
             basedir="${classes.dir}"
             includes="${package.dir}/core/**"
             excludes="**/Test*.class" />
        <checksum file="${distribution.dir}/lib/${core.jar.name}"
                  toDir="${distribution.dir}"/>
    </target>


    <target name="buildJGraphJar"
            depends="compile,copyLibs"
  	        description="Build the Editor's modified JGraph library">

        <jar jarfile="${distribution.dir}/lib/${jgraph.jar.name}"
             basedir="${classes.dir}"
             includes="org/jgraph/**"
             excludes="**/Test*.class" />
        <checksum file="${distribution.dir}/lib/${jgraph.jar.name}"
                  toDir="${distribution.dir}"/>
    </target>


    <target name="copyLibs"
            depends="compile"
  	        description="Creates lib folder and copies in required jar libraries">

    	<mkdir dir="${distribution.dir}/lib" />
    	<copy todir="${distribution.dir}/lib">
    		<fileset refid="editorOnlyDeps" />
    		<fileset refid="neededEngineDeps" />
    		<fileset file="../${compatible.engine.libJAR.path}" />
    	</copy>
    </target>


    <target name="buildJars"
            depends="buildAnalyserJar,buildCoreJar,buildJGraphJar,buildResourcesJar,buildUIJar"
            description="Builds all jars and copies required libraries"/>

	<!--
		Generate javadoc for all non-test code (unlike javac, we have to
	    specify all source explicitly). Can be run separately, or as part of
	    a full build
	-->
    <target name="document"
            depends="initialize"
            description="Generate Javadocs for the source-code">

        <mkdir dir="${javadoc.dir}" />
        <javadoc packagenames="org.yawlfoundation.yawl.editor.*"
                 source="${source.release}"
                 destdir="${javadoc.dir}"
                 author="true"
                 version="true"
                 use="true"
                 windowtitle="YAWLEditor ${editor.release.number} API">

        	<arg value="-J-Dhttp.proxyHost=${proxy.host}"/>
        	<arg value="-J-Dhttp.proxyPort=${proxy.port}"/>

        	<fileset dir="${source.dir}" defaultexcludes="yes">
        		<include name="**/*.java" />
        		<exclude name="**/Test*.java" />
        	</fileset>
        	<classpath>
        		<pathelement location="../${compatible.engine.libJAR.path}" />
        		<fileset refid="editorOnlyDeps" />
        		<fileset refid="neededEngineDeps" />
        	</classpath>
	        <doctitle>
	            <![CDATA[<h1>YAWLEditor ${editor.release.number} API</h1>]]>
	        </doctitle>
            <link offline="false" href="http://java.sun.com/j2se/1.5.0/docs/api/"/>
        </javadoc>
    </target>

	<!--
		Create ZIP of source code (for release)
	-->
	<target name="zipSourceCode"
	        depends="initialize"
	        description="Generate ZIP file of the source (for release)">
    
		<zip destfile="${distribution.dir}/${source.zip}">
        <zipfileset dir="${source.dir}" prefix="source"/>
	  	    <zipfileset dir="${library.dir}" prefix="lib"/>
		    <zipfileset dir="${tools.dir}" prefix="tools" />
		</zip>
        <checksum file="${distribution.dir}/${source.zip}" />

        <copy todir="${distribution.dir}" filtering="true">
            <fileset file="${source.dir}/ReleaseNotes.txt"/>
            <fileset file="${source.dir}/ChangeLog.txt"/>
        </copy>
    </target>

	<!--
		Environment clean/initialisation tasks.
	-->
    <target name="clean">
        <delete dir="${classes.dir}" />
        <delete dir="${javadoc.dir}" />
        <delete dir="${distribution.dir}" />
    </target>


    <target name="initialize" depends="clean">

        <!-- Create the time stamp & filter token for 'about' box -->
        <tstamp>
            <format property="buildDate" pattern="yyyy.MM.dd HH:mm:ss"/>
        </tstamp>
        <filter token="BuildDate" value="${buildDate}" />

        <!-- Create the distribution dir if it doesn't already exist -->
        <mkdir dir="${distribution.dir}" />
    </target>

	<!--
		Compile non-test code, filtering source code first to complete
	     tokenized values (using build.properties supplied values)
	-->
    <target name="compile" depends="initialize">
        <mkdir dir="${classes.dir}" />
        <copy todir="${classes.dir}/${package.dir}/ui/resources">
            <fileset dir="${source.dir}/${package.dir}/ui/resources">
                <include name="**/*" />
                <include name="**/*.*" />
            </fileset>
        </copy>

        <echo message="Compiling: ${source.file}" />
        <javac fork="yes"
               debug="yes"
               source="${source.release}"
               srcdir="${source.dir}"
               destdir="${classes.dir}">
            <include name="${source.file}" />
            <classpath>
            	<pathelement location="../${compatible.engine.libJAR.path}" />
        		<fileset refid="editorOnlyDeps" />
            	<fileset refid="neededEngineDeps" />
            </classpath>
        </javac>
    </target>


	<!-- ==================DEPLOYMENT RELATED TARGETS====================== -->

	<!--<target name="deployEditorLite" depends="buildEditorLite"-->
			<!--description="Build and deploy Editor Lite version">-->
		<!--<mkdir dir="${deploy.location}/lib" />-->
		<!--<copy todir="${deploy.location}">-->
			<!--<fileset file="${distribution.dir.lite}/${editor.lite.jar.name}" />-->
		<!--</copy>-->
		<!--<copy todir="${deploy.location}/lib">-->
			<!--<fileset dir="${distribution.dir.lite}/lib" includes="*.jar" />-->
		<!--</copy>-->
	<!--</target>-->

	<!--<target name="deployEditorComplete" depends="buildEditorComplete"-->
			<!--description="Build and deploy Editor Complete version">-->
		<!--<copy todir="${deploy.location}">-->
			<!--<fileset file="${distribution.dir.complete}/${editor.complete.jar.name}" />-->
		<!--</copy>-->
	<!--</target>-->

	<!--<target name="deployEditorBoth" depends="deployEditorLite, deployEditorComplete"-->
			<!--description="Build and deploy both Editor Complete and Lite versions" />-->


	<!-- ====================TESTING RELATED TARGETS======================= -->

	<!--
		Run all tests
	-->
    <target name="runTests"
            depends="compileTestFiles"
            description="Build and run all unit tests">

        <junit printsummary="true">
            <formatter type="plain" usefile="false" />
            <test name="org.yawlfoundation.yawl.editor.Test${root.class.name}" />
            <classpath>
                <pathelement location="${classes.dir}" />
                <fileset refid="junitDeps" />
            	<fileset refid="editorOnlyDeps" />
                <pathelement location="../${compatible.engine.libJAR.path}" />
            	<fileset refid="neededEngineDeps" />
           </classpath>
        </junit>
    </target>

	<!--
		Compile test-only source
	-->
    <target name="compileTestFiles"
            depends="compile"
            description="Compile test files from source">

        <echo message="Compiling Test: ${package.dir}/Test${root.source.file}" />
        <javac fork="yes"
               debug="yes"
               source="${source.release}"
               srcdir="${source.dir}"
               destdir="${classes.dir}">

            <include name="${package.dir}/Test${root.source.file}" />
            <classpath>
                <fileset refid="junitDeps" />
            </classpath>
        </javac>
    </target>

</project>